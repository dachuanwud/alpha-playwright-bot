# 📊 买单与卖单价格设置及磨损分析

## 📋 配置参数说明

### 价格配置（config.py）

```python
# 买入价格上浮百分比（默认 1.0002 = 上浮 0.02%）
buy_price_percent = 1.0002

# 买入价格固定差值（默认 0，可叠加使用）
buy_price_diff = 0

# 卖出价格百分比（默认 0.9998 = 下调 0.02%）
sell_price_percent = 0.9998
```

---

## 🔵 main.py（传统模式：先卖后买）

### 1. 卖出操作（_execute_sell）

#### 价格设置
```python
# 当前市价
current_price = self.buy_price  # 从页面获取的当前成交价

# 卖单价格（上浮，等待市场上涨成交）
sell_price = current_price × buy_price_percent
        = current_price × 1.0002  # 上浮 0.02%

# 反向买入价（卖出后自动挂的买单）
reverse_buy_price = sell_price × sell_price_percent
                  = sell_price × 0.9998  # 下调 0.02%
```

#### 示例计算
假设当前市价 = 0.075000 USDT：

```
当前市价 = 0.075000
卖价 = 0.075000 × 1.0002 = 0.075015  (上浮 0.02%)
反向买价 = 0.075015 × 0.9998 = 0.075000  (下调 0.02%)
```

#### 磨损分析
- **卖出时**：卖价高于市价 0.02%，如果立即成交则**无磨损**（甚至可能盈利）
- **反向买入时**：买价等于原市价，**无磨损**
- **一次完整交易（卖出→反向买入）**：理论上**无磨损**（如果都按设定价格成交）

---

### 2. 买入操作（_execute_buy）

#### 价格设置
```python
# 当前市价
current_price = self.buy_price  # 从页面获取的当前成交价

# 买单价格（上浮，确保快速成交）
buy_price = current_price × buy_price_percent + buy_price_diff
         = current_price × 1.0002 + 0  # 上浮 0.02%

# 反向卖出价（买入后自动挂的卖单）
reverse_sell_price = buy_price × sell_price_percent
                   = buy_price × 0.9998  # 下调 0.02%
```

#### 示例计算
假设当前市价 = 0.075000 USDT：

```
当前市价 = 0.075000
买价 = 0.075000 × 1.0002 + 0 = 0.075015  (上浮 0.02%)
反向卖价 = 0.075015 × 0.9998 = 0.075000  (下调 0.02%)
```

#### 磨损分析
- **买入时**：买价高于市价 0.02%，**产生 0.02% 磨损**
- **反向卖出时**：卖价等于原市价，**无磨损**
- **一次完整交易（买入→反向卖出）**：**总磨损 0.02%**

---

## 🟢 main_new.py（纯反向订单模式：先买后卖）

### 1. 买入操作（_execute_buy_with_reverse）

#### 价格设置
```python
# 当前市价
current_price = self.buy_price  # 从页面获取的当前成交价

# 买单价格（上浮，确保快速成交）
buy_price = current_price × buy_price_percent + buy_price_diff
         = current_price × 1.0002 + 0  # 上浮 0.02%

# 反向卖出价（买入后自动挂的卖单）
reverse_sell_price = buy_price × sell_price_percent
                   = buy_price × 0.9998  # 下调 0.02%
```

#### 示例计算
假设当前市价 = 0.075000 USDT：

```
当前市价 = 0.075000
买价 = 0.075000 × 1.0002 + 0 = 0.075015  (上浮 0.02%)
反向卖价 = 0.075015 × 0.9998 = 0.075000  (下调 0.02%)
```

#### 磨损分析
- **买入时**：买价高于市价 0.02%，**产生 0.02% 磨损**
- **反向卖出时**：卖价等于原市价，**无磨损**
- **一次完整交易（买入→反向卖出）**：**总磨损 0.02%**

---

### 2. 市价卖出操作（_market_sell，反向卖单超时后使用）

#### 价格设置
```python
# 当前市价
current_price = self.buy_price  # 从页面获取的当前成交价

# 市价卖出（略低于市价，确保快速成交）
sell_price = current_price × sell_price_percent
          = current_price × 0.9998  # 下调 0.02%
```

#### 示例计算
假设当前市价 = 0.075000 USDT：

```
当前市价 = 0.075000
市价卖价 = 0.075000 × 0.9998 = 0.074985  (下调 0.02%)
```

#### 磨损分析
- **市价卖出时**：卖价低于市价 0.02%，**产生 0.02% 磨损**
- **如果反向卖单已成交**：则按反向卖价（0.075000）成交，**无额外磨损**
- **如果反向卖单超时，使用市价卖出**：**额外产生 0.02% 磨损**

---

## 📈 完整交易循环磨损总结

### main.py 模式（卖出→买入）

| 步骤 | 操作 | 价格设置 | 磨损 |
|------|------|----------|------|
| 1 | 卖出 | 市价 × 1.0002 | 0% (上浮，等待成交) |
| 2 | 反向买入 | 卖价 × 0.9998 | 0% (等于原市价) |
| 3 | 买入 | 市价 × 1.0002 | 0.02% |
| 4 | 反向卖出 | 买价 × 0.9998 | 0% (等于原市价) |
| **总计** | **一次完整循环** | - | **0.02%** |

### main_new.py 模式（买入→反向卖出）

| 步骤 | 操作 | 价格设置 | 磨损 |
|------|------|----------|------|
| 1 | 买入 | 市价 × 1.0002 | 0.02% |
| 2 | 反向卖出 | 买价 × 0.9998 | 0% (等于原市价) |
| **总计** | **一次完整交易** | - | **0.02%** |

**特殊情况**：如果反向卖单超时，使用市价卖出：
- 买入磨损：0.02%
- 市价卖出磨损：0.02%
- **总磨损：0.04%**

---

## 💡 磨损优化建议

### 1. 价格参数调整

#### 降低买入磨损
```python
# 当前：buy_price_percent = 1.0002 (上浮 0.02%)
# 建议：buy_price_percent = 1.0001 (上浮 0.01%)
# 效果：买入磨损从 0.02% 降至 0.01%
```

#### 降低卖出磨损（main_new.py 市价卖出）
```python
# 当前：sell_price_percent = 0.9998 (下调 0.02%)
# 建议：sell_price_percent = 0.9999 (下调 0.01%)
# 效果：市价卖出磨损从 0.02% 降至 0.01%
```

### 2. 交易策略优化

#### main.py 模式
- ✅ **优势**：卖出时上浮，等待市场上涨成交，可能减少磨损
- ⚠️ **风险**：如果市场下跌，卖单可能长时间不成交

#### main_new.py 模式
- ✅ **优势**：流程简单，依赖反向订单自动成交
- ⚠️ **风险**：如果反向卖单超时，需要市价卖出，产生额外磨损

### 3. 实际磨损计算

假设单次交易额 = 256 USDT，当前价格 = 0.075000：

```
买入数量 = 256 / 0.075015 ≈ 3412.23 个币
买入成本 = 256 USDT
买入磨损 = 256 × 0.02% = 0.0512 USDT

反向卖出收入 = 3412.23 × 0.075000 ≈ 255.92 USDT
卖出磨损 = 0 USDT（按原市价成交）

单次交易净磨损 = 0.0512 USDT
36次交易总磨损 ≈ 1.84 USDT
```

---

## ⚠️ 注意事项

1. **价格波动风险**：如果市场价格快速变化，实际成交价可能与设定价不同
2. **滑点影响**：Binance 可能因滑点警告取消交易，需要处理
3. **挂单超时**：如果挂单长时间不成交，可能产生额外磨损（取消后重新下单）
4. **反向订单依赖**：main_new.py 模式依赖反向订单自动成交，如果超时需要主动卖出

---

## 📝 配置示例

### 最小磨损配置
```env
BUY_PRICE_PERCENT=1.0001    # 买入上浮 0.01%
BUY_PRICE_DIFF=0            # 无固定差值
SELL_PRICE_PERCENT=0.9999   # 卖出下调 0.01%
```

### 快速成交配置（当前默认）
```env
BUY_PRICE_PERCENT=1.0002    # 买入上浮 0.02%
BUY_PRICE_DIFF=0            # 无固定差值
SELL_PRICE_PERCENT=0.9998   # 卖出下调 0.02%
```

---

## 🔍 代码位置参考

- **价格配置**：`config.py:58-65`
- **买入价格设置**：`main.py:458` / `main_new.py:422`
- **卖出价格设置**：`main.py:268` / `main_new.py:264`
- **反向订单价格**：`main.py:289,468` / `main_new.py:430`

